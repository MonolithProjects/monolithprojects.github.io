<!doctype html><html><head><title>Docker Part 1.</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link rel=stylesheet href=/css/katex.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><meta property="og:title" content="Docker Part 1."><meta property="og:description" content="Ako Docker vytvara kontajnery"><meta property="og:type" content="article"><meta property="og:url" content="https://monolithprojects.github.io/posts/slovak/tech/docker1/"><meta property="article:published_time" content="2022-01-23T01:50:25+02:00"><meta property="article:modified_time" content="2022-01-23T01:50:25+02:00"><meta name=description content="Ako Docker vytvara kontajnery"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Satellite</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/opensource/ title="Open-Source Dashboard">Open-Source Dashboard</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/english/>English posts</a><ul><li><a href=/posts/english/personal/ title="Personal posts (eng)">Personal posts (eng)</a></li><li><a href=/posts/english/tech/ title="Tech posts (eng)">Tech posts (eng)</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/>Slovak posts</a><ul class=active><li><i class="fas fa-plus-circle"></i><a href=/posts/slovak/personal/>Personal posts (sk)</a><ul><li><a href=/posts/slovak/personal/iceland/ title="Naprieč Islandom">Naprieč Islandom</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/slovak/tech/>Tech posts (sk)</a><ul class=active><li><a href=/posts/slovak/tech/ansibletemplating/ title="Ansible templating">Ansible templating</a></li><li><a class=active href=/posts/slovak/tech/docker1/ title="Docker part 1">Docker part 1</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://monolithprojects.github.io/posts/slovak/tech/docker1/title.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/mike_hud321ed058f03c8018488331212da943d_254429_120x120_fit_box_2.png alt="Author Image"><h5 class=author-name></h5><p>:date_full</p></div><div class=title><h1>Docker Part 1.</h1></div><div class=taxonomy-terms><ul><li class=rounded><a href=/tags/tech class="btn, btn-sm">tech</a></li><li class=rounded><a href=/tags/slovak class="btn, btn-sm">slovak</a></li></ul></div><div class=post-content id=post-content><p>V tomto seriali by som chcel popísať, ako Docker vytvára kontainery.</p><h3 id=čo-je-to-kontajner>Čo je to kontajner</h3><p>Dnes existujú rôzne technológie, ktoré sa zaoberajú vytváraním kontajnerov. Dá sa dokonca povedať, že je okolo nich celkom pekný hype. Určite si už videl nejaké cool prezentácie o niečom čo sa volá Docker kde ti bolo jednoducho povedané, že Docker využíva namespaces, cgroups, chroot, atď. na vytváranie kontajnerov. Ale načo je toto všetko potrebné na vytvorenie kontajnera?
Prečo to nieje jednoducho systémove volanie a hotovo? Pretože realita je taká, že kontajnery neexistujú - sú vymyslené. Nič také ako &ldquo;linux container&rdquo; v kerneli nieje. Kontajner patri do oblasti user space a teda mimo kernelu.</p><h3 id=namespaces>Namespaces</h3><p>Na začiatok si povieme niečo o Linux namespace aby bolo jasné ako sú použité v rámci Dockeru. A neskor sa pozrieme na to, ako sú namespaces kombinované so cgroups a izolovanými filsystémami na vytvorenie niečoho užitočného.</p><p>Najskor by by som mal povedať podstatu namespaces a načo sú užitočné. Namespace je funkcia Linux kernelu rozparticiovať rôzne resourcy do separatneho &ldquo;priestoru&rdquo;, kde skupina resourcov (napríklad procesov) v jednom priestore/namespace vidi iba resourcy patriace do toho istého namespacu. Linux kernel pozná niekoľko typov namespacov. Kukneme sa na ne.</p><h3 id=net-namespace>NET Namespace</h3><p>Sieťový namespace poskytuje vlastný pohľad na network stack tvojho sytému. Do toho môže byť zahrnuý aj <code>localhost</code>. V tomto príklade je pohlad z vnútra docker kontajnera bežiaceho s <code>--net host</code> a teda schopného vidieť všetky sieťové rozhrania hostu.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@virt01:/containers# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#ae81ff>1000</span>
    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff
    inet 192.168.160.101/24 brd 192.168.160.255 scope global enp1s0
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fefd:43c0/64 scope link
       valid_lft forever preferred_lft forever
3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noqueue state UP group default
    link/ether 02:42:ab:3d:e1:a2 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:abff:fe3d:e1a2/64 scope link
       valid_lft forever preferred_lft forever
</code></pre></div><p>Namespacy sú primárne ovládané pomocou clone flags. Pri systemovom volaní &ldquo;clone&rdquo; na vytvorenie nového sieťového namespace pre subproces je použitá variabla <code>CLONE_NEWNET</code> a tento namespace je neskôr spárovaný s <code>veth</code> takže kontajner dostane vlastnú IP alokovanú na bridge, väčšinou <code>docker0</code>.</p><h3 id=mnt-namespace>MNT Namespace</h3><p>Mount namespace ti dáva špecifikovaný pohľad na mounty na tvojom filesysteme. Ľudia si často tento namespace zamieňajú s jailingom procesu vnútri <code>chroot</code> a podobne. Lenže to nieje pravda. Mount namespace nieje to isté ako filesystem jail. <code>chroot</code> je fajn ale ten neposkytuje kompletnú izoláciu a jeho efekt je obmedzený iba na root mountpoint. Samostatný mount namespace docoľuje aby každý z izolovaných procesov mal vlastný pohľad na pôvodny mountpoint sysému.</p><p>Na vytvorenie nového mount namespace sa používa variable <code>CLONE_NEWNS</code>. Wait&mldr; čože? Nie CLONE_NEWMOUNT alebo CLONE_NEWMNT? Nie, pretože mount namespace bol úplne prvý namespace a tato variabla mu jednoducho ostala.</p><h3 id=uts-namespace>UTS Namespace</h3><p>Ďalší namespace je UTS namespace. Ten je zodpovedný za identifikáciu systému. To zahŕňa <code>hostname</code> a <code>domainname</code>. Jednoducho umožňuje kontajneru mať svoj vlastný hostname, nezávisle na hostovi a ostatných kontajneroch. Tu je ako flag použitý <code>CLONE_NEWUTS</code>. Štandardne je jeho hodnota zdedená z hostu.</p><h3 id=ipc-namespace>IPC Namespace</h3><p>IPC namespace slúži na izolovanie komunikácie medzi procesmi, ako SysV alebo message queues. Tu sa používa flag <code>CLONE_NEWIPC</code></p><h3 id=pid-namespace>PID Namespace</h3><p>Tento namespace zabezpečuje s ktorými proces ID možes komunikovať a vidieť ich. Keď vytvoríš novy PID namespace, prvý proces bude PID 1. Ak tento proces existuje, kernel killne všetky ostatné v rámci tohto namespace.</p><p>Clone flag pre tento namespace je <code>CLONE_NEWPID</code>. Ak sa teraz pozriem na jednoduchý kontajner s <code>CMD ["bash"]</code> uvidím toto:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@virt01:/containers# ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         <span style=color:#ae81ff>1</span>  0.0  0.1  <span style=color:#ae81ff>20236</span>  <span style=color:#ae81ff>3108</span> pts/0    Ss   15:11   0:00 bash
root        <span style=color:#ae81ff>11</span>  0.0  0.0  <span style=color:#ae81ff>17492</span>  <span style=color:#ae81ff>2060</span> pts/0    R+   16:19   0:00 ps aux
</code></pre></div><h3 id=user-namespace>USER Namespace</h3><p>Aby sa zabezpečila prevencia proti <code>privilege-escalation</code> útokom, je vhodné aplikáciu v kontajnery nakonfigurovať tak, aby používala neprivilegovaného usera. Ak to nieje možné a proces v kontajneri musí bežať ako <code>root</code> použi user namespace. Tento namespace zabezpečí, že môžeš mať užívateľov v rámci jedneho namespace ktorý niesú tí istí užívatelia mimo tohto namespace. To znamená, že vďaka user namespace, môže byť user <code>root</code> vramci kontajnera ale zároveň ako &ldquo;neroot&rdquo; na hoste. Toto je docielené vďaka UID a GID mapingu.</p><p>Clone flag je použitý <code>CLONE_NEWUSER</code>.</p><h3 id=a-na-záver>A na záver</h3><p>Takže pre rekapituláciu prešiel som cez Network, Mount, IPC, UTS, PID a User namespaces. Niekedy nabudúce sa pozriem ako sa jailne proces kontajnera na root filesysteme (docker image) a na používanie cgroups.</p><hr></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn btn-sm facebook-btn" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fmonolithprojects.github.io%2fposts%2fslovak%2ftech%2fdocker1%2f" target=_blank><i class="fab fa-facebook"></i></a><a class="btn btn-sm twitter-btn" href="https://twitter.com/share?url=https%3a%2f%2fmonolithprojects.github.io%2fposts%2fslovak%2ftech%2fdocker1%2f&text=Docker%20Part%201.&via=Satellite" target=_blank><i class="fab fa-twitter"></i></a><a class="btn btn-sm reddit-btn" href="https://reddit.com/submit?url=https%3a%2f%2fmonolithprojects.github.io%2fposts%2fslovak%2ftech%2fdocker1%2f&title=Docker%20Part%201." target=_blank><i class="fab fa-reddit"></i></a><a class="btn btn-sm linkedin-btn" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fmonolithprojects.github.io%2fposts%2fslovak%2ftech%2fdocker1%2f&title=Docker%20Part%201." target=_blank><i class="fab fa-linkedin"></i></a><a class="btn btn-sm whatsapp-btn" href="https://api.whatsapp.com/send?text=Docker%20Part%201. https%3a%2f%2fmonolithprojects.github.io%2fposts%2fslovak%2ftech%2fdocker1%2f" target=_blank><i class="fab fa-whatsapp"></i></a><a class="btn btn-sm email-btn" href="mailto:?subject=Docker%20Part%201.&body=https%3a%2f%2fmonolithprojects.github.io%2fposts%2fslovak%2ftech%2fdocker1%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/monolithprojects/monolithprojects.github.io/edit/main/content/posts/slovak/tech/docker1/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/slovak/tech/ansibletemplating/ title="Ansible templating" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i>Prev</div><div class=next-prev-text>Ansible templating</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#čo-je-to-kontajner>Čo je to kontajner</a></li><li><a href=#namespaces>Namespaces</a></li><li><a href=#net-namespace>NET Namespace</a></li><li><a href=#mnt-namespace>MNT Namespace</a></li><li><a href=#uts-namespace>UTS Namespace</a></li><li><a href=#ipc-namespace>IPC Namespace</a></li><li><a href=#pid-namespace>PID Namespace</a></li><li><a href=#user-namespace>USER Namespace</a></li><li><a href=#a-na-záver>A na záver</a></li></ul></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://monolithprojects.github.io#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://monolithprojects.github.io#skills>Some of my skills</a></li><li class=nav-item><a class=smooth-scroll href=https://monolithprojects.github.io#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://monolithprojects.github.io#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:mike.muransky@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span><span>mike.muransky@gmail.com</span></a></li></ul></div><div class="col-md-4 col-sm-12"><p>Stay up to date with email notification</p><form action="https://github.us1.list-manage.com/subscribe/post?u=19de52a4603135aae97163fd8&amp;amp;id=094a24c76e" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div class=form-group><input type=email class=form-control id=mce-EMAIL name=EMAIL aria-describedby=emailHelp placeholder="Enter email">
<small id=emailHelp class="form-text text-muted">By entering your email address, you agree to receive the newsletter of this website.</small></div><button type=submit class="btn btn-info">Submit</button></form></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script type=text/javascript defer src=/js/katex.min.js></script><script type=text/javascript defer src=/js/auto-render.min.js onload=renderMathInElement(document.body);></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>